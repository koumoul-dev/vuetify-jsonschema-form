<script setup>
// @ts-nocheck

import { StatefulLayout } from '@json-layout/core'
import { ref, shallowRef, getCurrentInstance, useSlots } from 'vue'
import { useElementSize } from '@vueuse/core'

import { defaultOptions } from '<%- baseImport %>/options.js'
import Tree from '<%- baseImport %>/tree.vue'
<% comps.forEach(function(comp){ %>
import <%= comp.replace(/-/g, '') %>Node from '<%- baseImport %>/nodes/<%= comp %>.vue'
<% }); %>

<%- compiledLayoutCode %>

const vueInstance = getCurrentInstance()
<% comps.forEach(function(comp){ %>
if (!vueInstance?.appContext.app.component('vjsf-node-<%= comp %>')) {
  vueInstance.appContext.app.component('vjsf-node-<%= comp %>', <%= comp.replace(/-/g, '') %>Node)
}
<% }); %>

const props = defineProps(['modelValue', 'options'])
const emit = defineEmits(['update:modelValue', 'update:state'])

const statefulLayout = shallowRef(null)
const stateTree = shallowRef(null)

const el = ref(null)
const { width } = useElementSize(el)

const slots = useSlots()

const fullOptions = computed(() => {
  if (!width.value) return null
  return {
    ...defaultOptions,
    ...props.options,
    context: props.options.context ? JSON.parse(JSON.stringify(props.options.context)) : {},
    width: Math.round(width.value),
    vjsfSlots: { ...slots }
  }
})

const initStatefulLayout = () => {
  if (!fullOptions.value) return
  const _statefulLayout = new StatefulLayout(compiledLayout, compiledLayout.skeletonTree, fullOptions.value, props.modelValue)
  statefulLayout.value = _statefulLayout
  stateTree.value = _statefulLayout.stateTree
  _statefulLayout.events.on('update', () => {
    stateTree.value = _statefulLayout.stateTree
    emit('update:modelValue', _statefulLayout.data)
    emit('update:state', _statefulLayout)
  })
  emit('update:state', _statefulLayout)
}

watch(fullOptions, (newOptions) => {
  if (!newOptions) {
    statefulLayout.value = null
  } else if (statefulLayout.value) {
    statefulLayout.value.options = newOptions
  } else {
    initStatefulLayout()
  }
})

// case where data is updated from outside
watch(() => props.modelValue, (newData) => {
  if (statefulLayout.value && statefulLayout.value.data !== newData) statefulLayout.value.data = newData
})

</script>

<template>
  <div ref="el">
    <tree
      v-if="statefulLayout && stateTree"
      :model-value="stateTree"
      :stateful-layout="statefulLayout"
    />
  </div>
</template>